<!--
  New Modern Inbox Layout
  - Uses CSS variables from _core-design.scss
  - Responsive design for Desktop (2-pane) and Mobile (1-pane view with transitions)
  - Uses modern Angular control flow syntax (@if, @for)
  - Improved accessibility and user experience
-->
<div class="inbox-container">

  <!-- Toolbar: Search, Filters, and Actions -->
  <div class="inbox-toolbar">
    <!-- Search Input -->
    <div class="search-input-container input-group">
      <span class="input-group-text bg-transparent border-0"><i class="mdi mdi-magnify"></i></span>
      <input
        type="text"
        class="form-control border-0 bg-transparent"
        placeholder="{{ 'systemcode.search' | translate }} {{ 'Doc No.' | translate }}, {{ 'subject' | translate }}, {{ 'sender' | translate }}"
        [ngModel]="docNo"
        (ngModelChange)="changeDocNo($event); scrollToTop('workflowDataList')"
      />
    </div>

    <!-- Filter Pills -->
    <div class="filter-pills-container">
      <span class="filter-label d-none d-md-inline">{{"status" | translate}}:</span>
      @for (status of [ { key: 'active', code: 1 }, { key: 'return', code: 7 } ]; track status.key) {
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" style="margin-right: 5px;" [id]="'statusCheck_' + status.key" [value]="status.code" [(ngModel)]="wfStatus[status.key].check" (change)="firstGetInboxMyHRPage()">
          <label class="custom-control-label" [for]="'statusCheck_' + status.key">{{ 'wf_' + status.key | translate }}</label>
        </div>
      }
      <div class="custom-control custom-checkbox">
        <input type="checkbox" class="custom-control-input" style="margin-right: 5px;" id="statusCheck_cc" [value]="13" [(ngModel)]="wfStatus.cc.check" (change)="firstGetInboxMyHRPage()">
        <label class="custom-control-label" for="statusCheck_cc">{{ 'cc' | translate }}</label>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button type="button" class="btn btn-primary" (click)="workflowApproveAll()" [disabled]="!hasSelectedItems() || submitLoading">
        <i class="mdi mdi-check-all me-1"></i>
        {{ "systemcpde.welfare.history.approvestatus.1" | translate }}
      </button>
      <button type="button" class="btn btn-success" (click)="openCreateDocModal()" [disabled]="submitLoading">
        <i class="mdi mdi-plus me-1"></i>
        {{ "menu.myhr-create-doc" | translate }}
      </button>
    </div>
  </div>

  <!-- Loading Overlay -->
  @if (workflowListLoading || submitLoading) {
    <div class="loading-container">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }

  <!-- Main Content: List and Detail Panes -->
  <div class="inbox-main-content">
    <!-- Left Pane: Workflow List -->
    <div class="inbox-list-pane" [class.detail-visible]="workflow && !windowWidth(768)">
      <div class="list-pane-header">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="selectAllCheckbox" (change)="checkboxAll($event.target.checked)" [disabled]="workflowList.length === 0">
          <label class="form-check-label list-title" for="selectAllCheckbox">
            {{ 'systemcode.select.all' | translate }}
          </label>
        </div>
        <span class="list-count">{{ 'all' | translate }} {{ workflowList.length }} {{ 'Note(s)' | translate }}</span>
      </div>

      <div #workflowDataList class="list-pane-body">
        @if (workflowList.length > 0) {
          @for (item of workflowList | slice:(page-1) * pageSize : (page-1) * pageSize + pageSize; track item.data.wf_id) {
            <div
              class="workflow-item"
              [class.active]="workflow?.wf_id === item.data.wf_id"
              [class.unread]="item.data.readCheck === '0'"
              (click)="openWorkflowDetail(item.data); readWorkflow(item.data, $index)">
              <div class="item-select">
                <input
                  type="checkbox"
                  class="form-check-input"
                  [(ngModel)]="item.checkbox"
                  [disabled]="item.data.status !== '0' || item.data.aiStatus === 13"
                  (click)="$event.stopPropagation()"
                />
              </div>
              <div class="item-avatar">
                <img appShowLoading src="{{ jbossUrl + '/FileViewer.jsp?uploadfield=memployee.picture&filename=' + item.data.initiator_pic }}" alt="user" />
              </div>
              <div class="item-content">
                <div class="content-header">
                  <span class="sender-name" title="{{ item.data.getInitiatorDesc() }}">{{ item.data.getInitiatorDesc() }}</span>
                  <span class="timestamp" [ngbTooltip]="(convertDate(item.data.date) | thaidate:'fullNotYear') + ' ' + convertTime(item.data.date)" container="body">
                    {{ (convertDate(item.data.date) | date:'EE') | translate }} {{ convertTime(item.data.date) }}
                  </span>
                </div>
                <div class="content-subject" title="{{ item.data.getSubjectDesc() }}">
                  {{ item.data.getSubjectDesc() }}
                </div>
                <div class="content-footer">
                  <span class="doc-no">{{ item.data.docNo }}</span>
                  <div class="status-icon" [ngbTooltip]="getWorkflowStatusInfo(item.data).tooltip | translate" container="body">
                     <i class="mdi" [ngClass]="getWorkflowStatusInfo(item.data).icon" [style.color]="getWorkflowStatusInfo(item.data).color"></i>
                  </div>
                </div>
              </div>
            </div>
          }
        } @else if (!workflowListLoading) {
          <div class="empty-list-message">
            <i class="mdi mdi-email-open-outline"></i>
            <h5>{{ 'No Data Found' | translate }}</h5>
            <p>{{ 'Your inbox is currently empty.' | translate }}</p>
          </div>
        }
      </div>

      @if (workflowList.length > pageSize) {
        <div class="list-pane-footer">
          <ngb-pagination
            [collectionSize]="workflowList.length"
            [(page)]="page"
            [pageSize]="pageSize"
            [maxSize]="5"
            [rotate]="true"
            [ellipses]="false"
            (pageChange)="scrollToTop('workflowDataList')">
          </ngb-pagination>
        </div>
      }
    </div>

    <!-- Right Pane: Workflow Detail -->
    <div class="inbox-detail-pane" [class.visible]="workflow && !windowWidth(768)">
      @if (workflow) {
        <div class="detail-content-wrapper">
          <div class="detail-header">
            <button class="btn btn-icon btn-light-secondary back-button" (click)="workflow = undefined">
              <i class="mdi mdi-arrow-left"></i>
            </button>
            <h4 class="detail-subject" title="{{ workflow.getSubjectDesc() }}">{{ workflow.getSubjectDesc() }}</h4>
            <div class="status-icon" [ngbTooltip]="getWorkflowStatusInfo(workflow).tooltip | translate" container="body">
                <i class="mdi" [ngClass]="getWorkflowStatusInfo(workflow).icon" [style.color]="getWorkflowStatusInfo(workflow).color"></i>
            </div>
          </div>
          <div #workflowDataShow class="detail-body">
            <!-- The existing workflow-type component will render the details -->
            <app-workflow-type
              [workflow]="workflow"
              [fromPage]="'inbox'"
              (newLoading)="firstGetInboxMyHRPage($event)"
              [cc]="workflow.aiStatus === 13">
            </app-workflow-type>
          </div>
        </div>
      } @else {
        <div class="placeholder">
          <i class="mdi mdi-email-outline"></i>
          <h5>{{ 'systemcode.select.workflow' | translate }}</h5>
          <p>{{ 'Select an item from the list to see the details.' | translate }}</p>
        </div>
      }
    </div>
  </div>
</div>

<!--
  The modal for 'Zeeme' integration is kept as is, but could be refactored
  into a standalone component for better separation of concerns.
-->
<ng-template #openModalWorkflow let-modal>
  <div class="modal-header bg-myhr">
    <h5 class="modal-title text-white">{{ workflow?.getSubjectDesc() }}</h5>
    <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('Cross click')" aria-label="Close"></button>
  </div>
  <div class="modal-body p-0">
    @if (workflow) {
      <app-workflow-type
        [workflow]="workflow"
        [fromPage]="'inbox'"
        (newLoading)="firstGetInboxMyHRPage()">
      </app-workflow-type>
    }
  </div>
</ng-template>
