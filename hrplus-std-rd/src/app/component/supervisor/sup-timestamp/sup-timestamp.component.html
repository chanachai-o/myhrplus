<div class="main-content-card">
    <div class="card-header bg-myhr">
        <h4 class="mb-0 text-white"><i class="far fa-clock me-2"></i>{{"Working Time Details" | translate}}</h4>
    </div>
    <div class="card-body p-3 p-lg-4">
        <!-- Filters Section -->
        <div class="filter-bar mb-3">
            <div class="filter-bar-item flex-grow-1">
                <label class="form-label">{{"filter_by_subordinate_group" | translate}}</label>
                <div class="input-group">
                    <input id="typeahead-focus" type="text" class="form-control"
                        placeholder="{{'subordinate.group.id'| translate}}" [(ngModel)]="model" [ngbTypeahead]="search"
                        [inputFormatter]="formatter" (focus)="focus$.next($any($event).target.value)"
                        (click)="click$.next($any($event).target.value)" #instance="ngbTypeahead" [resultTemplate]="rt"
                        (ngModelChange)="changeModel()" [ngModelOptions]="{standalone: true}">
                    <ng-template #rt let-r="result" let-t="term">{{ r.groupId }}</ng-template>
                    <input readonly type="text" class="form-control"
                        placeholder="{{'subordinate.description'| translate}}" [value]="model?.getDesc() || ''">
                    <button type="button" class="btn btn-outline-secondary" (click)="clearSearch()"><i
                            class="mdi mdi-close"></i></button>
                </div>
            </div>
            <div class="filter-bar-item">
                <label class="form-label">{{"filter_by_date" | translate}}</label>
                <div class="input-group">
                    <select class="form-select" [(ngModel)]="selectMonth" [ngModelOptions]="{standalone: true}">
                        @for (m of month; track m.val) {
                        <option [ngValue]="m.val">{{m.name | translate}}</option>
                        }
                    </select>
                    <select class="form-select" [(ngModel)]="selectYear" [ngModelOptions]="{standalone: true}">
                        @for (y of years; track y) {
                        <option [ngValue]="y">{{y}}</option>
                        }
                    </select>
                    <button type="button" class="btn btn-primary" (click)="selectDate()"><i
                            class="mdi mdi-magnify"></i></button>
                </div>
            </div>
            <div class="filter-bar-item d-flex align-items-end">
                <span class="badge rounded-pill badge-primary-light p-2 w-100">
                    {{'all'| translate}} <strong class="text-primary mx-1">{{totalElements || 0}}</strong> {{'person' |
                    translate}}
                </span>
            </div>
        </div>

        @if (loading) {
        <div class="d-flex justify-content-center p-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"><span
                    class="visually-hidden">Loading...</span></div>
        </div>
        } @else {
        <!-- Desktop Table View -->
        <div class="d-none d-lg-block table-responsive">
            <div class="wrapper">
                <table class="table table-bordered table-sm no-wrap v-middle">
                    <thead class="thead-light">
                        <tr>
                            <th class="fw-normal sticky-col-th first-col" style="width: 250px;">{{"Name-Surname" |
                                translate}}</th>
                            @for (day of [].constructor(31); track $index; let i = $index) {
                            <th class="fw-normal text-center" style="min-width: 45px;">{{i + 1}}</th>
                            }
                            <th class="fw-normal text-center" style="min-width: 80px;">{{"OT"| translate}}</th>
                            <th class="fw-normal text-center" style="min-width: 80px;">{{"Leave"| translate}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (emp of data; track emp.employee.employeeId) {
                        <tr>
                            <td class="sticky-col first-col">
                                <a class="link-myhr link-hover cursor-myhr"
                                    (click)="loadData(emp.employee.employeeId);getName(emp.employee.employeeId,emp.employee.getFullname());openDialog(dialog)">
                                    {{emp.employee.employeeId}}: {{emp.employee.getFullname()}}
                                </a>
                            </td>
                            @for (item of emp.timeCurrent; track $index) {
                            <td class="text-center" [ngStyle]="{'background-color': statusColor(item)}">
                                {{getTypeStatus(item)}}
                            </td>
                            }
                            <td>{{sumScoreOT(emp).toFixed(2)}}</td>
                            <td>{{sumScoreLt(emp).toFixed(2)}}</td>
                        </tr>
                        } @empty {
                        <tr>
                            <td colspan="34" class="text-center p-4">{{"No data to display" | translate}}</td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mobile Card View -->
        <div class="d-lg-none">
            @for (emp of data; track emp.employee.employeeId) {
            <div class="card info-card card-hover mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <a class="link-myhr link-hover"
                            (click)="loadData(emp.employee.employeeId);getName(emp.employee.employeeId,emp.employee.getFullname());openDialog(dialog)">
                            {{emp.employee.getFullname()}}
                        </a>
                    </h6>
                    <small class="text-muted">{{emp.employee.employeeId}}</small>
                </div>
                <div class="card-body">
                    <div class="row text-center my-2">
                        <div class="col-6 border-end">
                            <h4 class="mb-0 fw-bold">{{sumScoreOT(emp).toFixed(2)}}</h4>
                            <small class="text-muted">{{"OT" | translate}} ({{'hours' | translate}})</small>
                        </div>
                        <div class="col-6">
                            <h4 class="mb-0 fw-bold">{{sumScoreLt(emp).toFixed(2)}}</h4>
                            <small class="text-muted">{{"Leave" | translate}} ({{'hours' | translate}})</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <button class="btn btn-outline-primary w-100"
                        (click)="loadData(emp.employee.employeeId);getName(emp.employee.employeeId,emp.employee.getFullname());openDialog(dialog)">
                        {{"view_details" | translate}}
                    </button>
                </div>
            </div>
            } @empty {
            <div class="text-center p-4">{{"No data to display" | translate}}</div>
            }
        </div>

        <!-- Legend -->
        <div class="mt-4 p-3 bg-light rounded">
            <h6 class="mb-3 fw-bold">{{"legend" | translate}}</h6>
            <div class="filter-pills-container">
                <span class="badge text-bg-light">* = {{"No data"| translate}}</span>
                <span class="badge text-bg-light">L = {{"Leave"| translate}}</span>
                <span class="badge text-bg-light">A = {{"Absent"| translate}}</span>
                <span class="badge text-bg-light">O = {{"Overtime"| translate}}</span>
                <span class="badge text-bg-light">NP = {{"Not Punch"| translate}}</span>
                <span class="badge" style="background-color: #68cebc; color: white;">{{"Annual Holiday"|
                    translate}}</span>
                <span class="badge" style="background-color: #5f89ff; color: white;">{{"Work"| translate}}</span>
                <span class="badge" style="background-color: #f8627d; color: white;">{{"Day off"| translate}}</span>
            </div>
        </div>

        <!-- Pagination -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mt-4">
            <div class="mb-2 mb-sm-0">
                <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="pageSize"
                    (ngModelChange)="refreshData()">
                    <option [ngValue]="10">10 {{"items per page"| translate}}</option>
                    <option [ngValue]="50">50 {{"items per page"| translate}}</option>
                    <option [ngValue]="100">100 {{"items per page"| translate}}</option>
                </select>
            </div>
            <ngb-pagination [collectionSize]="collectionSize" [(page)]="page" [pageSize]="pageSize"
                (pageChange)="refreshData()" [maxSize]="3" [rotate]="true" [ellipses]="false" [boundaryLinks]="true">
            </ngb-pagination>
        </div>
        }
    </div>
</div>

<!-- Details Modal -->
<ng-template #dialog let-modal>
    <div class="modal-header">
        <h5 class="modal-title">{{"Working Time History Detail of Employee" | translate}}: {{id}} {{name}}</h5>
        <button type="button" class="btn-close" (click)="modal.close()" aria-label="Close"></button>
    </div>
    <div class="modal-body">
        <!-- Filter Section -->
        <div class="filter-pills-container p-3 mb-3 bg-light rounded">
            <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="modalCheckLate" [(ngModel)]="late"
                    (ngModelChange)="changeFilter()">
                <label class="form-check-label" for="modalCheckLate">{{"Display Late" | translate}}</label>
            </div>
            <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="modalCheckAbsent" [(ngModel)]="absent"
                    (ngModelChange)="changeFilter()">
                <label class="form-check-label" for="modalCheckAbsent">{{"Display Absent" | translate}}</label>
            </div>
            <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="modalCheckLeave" [(ngModel)]="leave"
                    (ngModelChange)="changeFilter()">
                <label class="form-check-label" for="modalCheckLeave">{{"Display Leave" | translate}}</label>
            </div>
            <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="modalCheckOT" [(ngModel)]="overtime"
                    (ngModelChange)="changeFilter()">
                <label class="form-check-label" for="modalCheckOT">{{"Display Overtime" | translate}}</label>
            </div>
        </div>

        <!-- Table Section -->
        <div class="table-responsive">
            <table class="table table-hover table-striped table-sm mb-0">
                <thead class="thead-light">
                    <tr>
                        <th class="text-center">{{"date" | translate}}</th>
                        <th class="text-center">{{"day" | translate}}</th>
                        <th class="text-center">{{"Shift ID" | translate}}</th>
                        <th class="text-center">{{"Work Time" | translate}}</th>
                        <th class="text-center">{{"Punch Time" | translate}}</th>
                        <th class="text-center">{{"Day Type" | translate}}</th>
                        <th class="text-center">{{"late" | translate}}</th>
                        <th class="text-center">{{"Absent" | translate}}</th>
                        <th class="text-center">{{"Leave" | translate}}</th>
                        <th class="text-center">{{"OT Total" | translate}}</th>
                        <th class="text-center">{{"OT" | translate}}1</th>
                        <th class="text-center">{{"OT" | translate}}1.5</th>
                        <th class="text-center">{{"OT" | translate}}2</th>
                        <th class="text-center">{{"OT" | translate}}3</th>
                        <th class="text-center">{{"Work" | translate}}</th>
                    </tr>
                </thead>
                <tbody>
                    @if (noData) {
                    <tr>
                        <td colspan="15" class="text-center p-4 text-muted">
                            <i class="far fa-folder-open fa-2x mb-2"></i><br>
                            {{"No Data Found" | translate}}
                        </td>
                    </tr>
                    } @else {
                    @for (item of dataTimeShow | slice: (pageModal-1) * pageSizeModal : (pageModal-1) * pageSizeModal +
                    pageSizeModal; track
                    item.dateid) {
                    <tr [class.text-danger]="item.eventgrp.tdesc === 'วันหยุด'"
                        [class.fw-bold]="item.eventgrp.tdesc === 'วันหยุด'">
                        <td class="text-center">{{item.dateid | date:'dd-MM-yyyy'}}</td>
                        <td class="text-center">{{"systemcode.memployee.workplan.day." +
                            convertyyyyMMddTodate(item.dateid) | translate}}</td>
                        <td class="text-center">{{item.time0id}}</td>
                        <td class="text-center">{{getFormatWorktime(item)}}</td>
                        <td class="text-center">{{getPunchtime(item)}}</td>
                        <td class="text-center">{{getEventGrpId(item)}}</td>
                        <td class="text-center">{{item.lt > 0 ? item.lt.toFixed(2) : ""}}</td>
                        <td class="text-center">{{item.eventgrp.eventgrpid == 'J' && (item.warn05 != undefined ||
                            item.warn05 != '') ? item.m_lv.toFixed(2) : ""}}</td>
                        <td class="text-center">{{item.m_lv > 0 && (item.tr_type.indexOf('A') == 0) ?
                            item.m_lv.toFixed(2) : ""}}</td>
                        <td class="text-center">{{item.ac_ot > 0 ? item.ac_ot.toFixed(2) : ""}}</td>
                        <td class="text-center">{{item.ot1 > 0 ? item.ot1.toFixed(2) : ""}}</td>
                        <td class="text-center">{{item.ot5 > 0 ? item.ot5.toFixed(2) : ""}}</td>
                        <td class="text-center">{{item.ot2 > 0 ? item.ot2.toFixed(2) : ""}}</td>
                        <td class="text-center">{{item.ot3 > 0 ? item.ot3.toFixed(2) : ""}}</td>
                        <td class="text-center">{{item.hour_d > 0 ? item.hour_d.toFixed(2) : ""}}</td>
                    </tr>
                    }
                    }
                </tbody>
                @if (dataTimeShow && !noData) {
                <tfoot class="total-row">
                    <tr>
                        <td colspan="6" class="text-end">{{"Total" | translate}}</td>
                        <td class="text-center">{{getTotalLate() | number:".2"}}</td>
                        <td class="text-center">{{getTotalAbsent() | number:".2"}}</td>
                        <td class="text-center">{{getTotalLeave() | number:".2"}}</td>
                        <td class="text-center">{{getTotalOtTotal() | number:".2"}}</td>
                        <td class="text-center">{{getTotalOt1() | number:".2"}}</td>
                        <td class="text-center">{{getTotalOt1_5() | number:".2"}}</td>
                        <td class="text-center">{{getTotalOt2() | number:".2"}}</td>
                        <td class="text-center">{{getTotalOt3() | number:".2"}}</td>
                        <td class="text-center">{{getTotalWork() | number:".2"}}</td>
                    </tr>
                </tfoot>
                }
            </table>
        </div>
    </div>
    <div class="modal-footer justify-content-between">
        <div class="d-flex align-items-center">
            <select class="form-select form-select-sm" style="width: auto" [(ngModel)]="pageSizeModal"
                (ngModelChange)="pageModal=1;getTotalData()">
                <option [ngValue]="10">10 {{"items per page"| translate}}</option>
                <option [ngValue]="50">50 {{"items per page"| translate}}</option>
                <option [ngValue]="100">100 {{"items per page"| translate}}</option>
            </select>
            <ngb-pagination [collectionSize]="dataTimeShow.length" [(page)]="pageModal" [pageSize]="pageSizeModal"
                [maxSize]="3" (pageChange)="getTotalData()" [rotate]="true"></ngb-pagination>
        </div>
        <button type="button" class="btn btn-danger" (click)="modal.close('Close click')">{{"Close"|
            translate}}</button>
    </div>
</ng-template>

<ng-template #alertModal let-modal>
    <div class="modal-header">
        <h5 class="modal-title">{{"Alert Message" | translate}}</h5>
        <button type="button" class="btn-close" (click)="closeBtnClick()" aria-label="Close"></button>
    </div>
    <div class="modal-body text-center">
        <i class="fas fa-exclamation-circle fa-3x text-warning mb-3"></i>
        <p>{{msg}}</p>
    </div>
    <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-primary" (click)="closeBtnClick()">{{"confirm"|translate}}</button>
    </div>
</ng-template>